@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>GetUserOpenidTest</title>
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
</head>
<body>
    <div>
        测试页面获取openId @ViewBag.openid
        <br />
        <button onclick="BuildOrder()">下单支付</button>
    </div>
    <script type="text/javascript">
        function BuildOrder() {
            $.ajax({
                type: "POST",
                url: "/Pay/BuildOrder",
                data: { "ProductId": "1", "openid": "@ViewBag.openid", "ArticleId": 0 },
                success: function (data) {
                    Pay(data.Data.AppId, data.Data.NonceStr, data.Data.TimeStamp, data.Data.NonceStr, data.Data.Package, data.Data.PaySign);
                },
                error: function () {
                    alert("请求失败");
                }

            });
        }

        function Pay(AppId, NonceStr, TimeStamp, NonceStr, Package, PaySign) {
            WeixinJSBridge.invoke(
               'getBrandWCPayRequest', {
                   "appId": AppId,     //公众号名称，由商户传入
                   "timeStamp": TimeStamp,         //时间戳，自1970年以来的秒数
                   "nonceStr": NonceStr, //随机串
                   "package": Package,
                   "signType": "MD5",         //微信签名方式：
                   "paySign": PaySign //微信签名
               },
               function (res) {
                   if (res.err_msg == "get_brand_wcpay_request:ok") {
                       alert("支付成功");
                       // 使用以上方式判断前端返回,微信团队郑重提示：
                       //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                   }
               });


        }
    </script>
</body>

</html>
